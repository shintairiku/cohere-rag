# **企業別・類似画像検索プロダクト 要件定義書**

## **1\. 概要**

本プロダクトは、企業ごとにGoogle Driveに保存されている大量の画像を、Googleスプレッドシートをインターフェースとして自然言語で検索可能にすることを目的とする。AI（Cohere API）を用いて画像とテキストをベクトル化し、その類似度を計算することで高精度な検索を実現する。

## **2\. プロダクトゴール**

* ユーザーが使い慣れたGoogleスプレッドシートから、直感的な操作で画像検索を行えるようにする。  
* 企業ごとに数万枚規模の画像が増減しても対応可能な、スケーラブルなベクトル化（インデックス作成）バッチ処理基盤を構築する。  
* 運用コストとメンテナンス性を考慮し、サーバーレスアーキテクチャ（Cloud Run）を全面的に採用する。

## **3\. システムアーキテクチャ**

本システムは、ユーザーインターフェースを担う**Google Workspace**と、バックエンド処理を担う\*\*Google Cloud Platform (GCP)\*\*の2つの主要コンポーネントで構成される。

### **3.1. コンポーネント一覧**

| コンポーネント | 種別 | 名称/ID | 役割 |
| :---- | :---- | :---- | :---- |
| **UI/操作層** | Google Sheets | 類似画像検索（統合版） | 企業情報管理、ベクトル化のトリガー、検索インターフェース |
|  | Google Apps Script | api\_caller.gs | スプレッドシート上の操作を検知し、バックエンドAPIを呼び出す |
| **受付/API層** | Cloud Run Service | cohere-rag-main | GASからのHTTPリクエストを受け付ける常時待機型のAPIサーバー |
| **バッチ処理層** | Cloud Run Job | cohere-rag-vectorize-job | 長時間実行されるベクトル化処理を担当するバッチジョブ |
| **データ保存層** | Cloud Storage | embedding\_storage | 企業ごとにベクトル化されたJSONデータを保存する |
| **外部サービス** | Google Drive | \- | 検索対象の元画像が保存されているストレージ |
|  | Cohere API | \- | 画像・テキストのベクトル化（Embedding）を行うAIモデル |
| **CI/CD** | Cloud Build | \- | GitHubリポジトリから2つのCloud Runリソースを自動デプロイ |

## **4\. 機能要件**

### **4.1. 企業情報管理 (Google Sheets)**

* **FR-1.1:** 会社一覧シートにて、企業名と、その企業が使用するGoogle DriveフォルダのURLを管理できる。  
* **FR-1.2:** 会社一覧シートに新しい企業が追加された際、Google Apps ScriptによってユニークID（UUID）が自動で採番され、A列に記録される。

### **4.2. 画像のベクトル化処理**

* **FR-2.1:** ユーザーは会社一覧シートで対象企業の行を選択し、カスタムメニューからベクトル化処理を開始できる。  
* **FR-2.2:** 処理が開始されると、GASはCloud Runサービス(main-service)の/vectorizeエンドポイントに、対象企業のuuidとdrive\_urlを渡してリクエストを送信する。  
* **FR-2.3:** /vectorizeエンドポイントはリクエストを受け取ると、Cloud Runジョブ(vectorize-job)の実行を開始するよう命令し、すぐにGASへ応答を返す。  
* **FR-2.4:** 起動したCloud Runジョブは、最大24時間の実行時間内で以下の処理を完了させる。  
  * **FR-2.4.1:** 指定されたGoogle Driveフォルダ内を再帰的にスキャンし、全画像ファイルのリストを取得する。  
  * **FR-2.4.2:** 各画像ファイルをメモリ上にダウンロードする。  
  * **FR-2.4.3:** 画像サイズが20MBを超える場合は、品質を維持しつつダウンサンプリングを行う。  
  * **FR-2.4.4:** 画像データとファイル名をセットでCohereのマルチモーダルモデルAPIに送信し、ベクトル値を取得する。  
  * **FR-2.4.5:** 全画像のベクトル化が完了後、結果を単一のJSONファイルにまとめる。  
* **FR-2.5:** 最終的なJSONファイルは、Cloud Storageバケットに\[uuid\].jsonというファイル名で保存される。

### **4.3. 画像検索機能 (Google Sheets)**

* **FR-3.1:** 検索は、企業ごとに用意されたシート（例: platform-尚建工務店）で行う。  
* **FR-3.2:** ユーザーがC列「実行状況」のプルダウンを変更すると、onEditトリガーによってGASが起動する。  
* **FR-3.3:** GASは、現在開いているシート名から対象企業のuuidを特定する。  
* **FR-3.4:** GASは、Cloud Runサービス(main-service)の/searchエンドポイントに、uuidと検索クエリを渡してリクエストを送信する。  
* **FR-3.5: 類似画像検索**  
  * 実行状況が「類似画像検索」に変更された場合、A列のテキストクエリを使用する。  
  * バックエンドは\[uuid\].jsonをGCSから読み込み、クエリと全画像ベクトルの類似度を計算する。  
  * 類似度が高い上位5件の画像情報（ファイル名、URL、類似度スコア）を返す。  
* **FR-3.6: ランダム画像検索**  
  * 実行状況が「ランダム画像検索」に変更された場合、バックエンドは\[uuid\].jsonからランダムに5件の画像情報を返す。  
* **FR-3.7:** GASはAPIから受け取った結果を、該当行のD列以降に書き込む。

## **5\. 非機能要件**

* **NFR-1. スケーラビリティ:** Cloud Runジョブの採用により、ベクトル化処理は最大24時間まで実行可能とし、数万枚単位の画像に対応できること。  
* **NFR-2. パフォーマンス:** 画像検索は、ユーザーがストレスを感じないよう、数秒以内に結果が返却されること。  
* **NFR-3. セキュリティ:** COHERE\_API\_KEYなどの機密情報は、Cloud Buildのトリガー変数として管理し、コード中に直接記述しないこと。  
* **NFR-4. 可用性:** バックエンドはサーバーレスアーキテクチャで構築され、GCPのSLAに準拠すること。  
* **NFR-5. 運用・保守:** デプロイはCloud Buildによって自動化され、手動でのデプロイ作業を不要とすること。役割の異なるコンポーネント（サービスとジョブ）は、同じリポジトリで管理できること。